#include "main.h"
#include "plugin.h"

static int testa_init(void);
static int testa_destroy(void);
static int testa_start(void);
static int testa_stop(void);

static bool flag_stop = false;

//  定义NNGclient结构体内容
const brickPluginRegister_TypeDef testa = {

    .init = testa_init,
    .destroy = testa_destroy,
    .start = testa_start,
    .stop = testa_stop,

    .moduleName = "testa",
    .moduleVersion = "ST03.001",
};

brickRouteClient_TypeDef *aClient = NULL;

static int testa_init(void)
{
    printf("testa_init is running\n");

    aClient = route_client_setDefault(&testa);
    assert(aClient != NULL);

    return 0;
}

static int testa_destroy(void)
{
    int ret;
    if ((ret = route_client_free(aClient)) != 0)
    {
        ERROR_ASSERT();
        return -1;
    }

    printf("testa_destroy.\n");
    return 0;
}

static int testa_start(void)
{
    char recv_str[2048] = {0};
    int ret;
    // const char data[]
    char data[] = "0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789\
0123465789012346578901234657890123465789012346578901234657890123465789012346578901234657890123465789";

    for (size_t i = 0; i < 4096; i++)
    {
        if ((ret = route_client_send(aClient, data, strlen(data))) != 0)
        {
            printf("route_client_send: %d\n", ret);
            return -1;
        }
        // printf("testa_start: route_client_send\n");

        memset(recv_str, 0x00, 2048);
        if ((ret = route_client_recv(aClient, recv_str)) > 0)
        {
            printf("%ld: [%d] %s\n", i, ret, recv_str);
        }
        else
        {
            assert(ret > 0);
        }

        usleep(5000);
    }

    // Prevent direct exit from the process.
    while (true)
    {
        if (flag_stop)
        {
            printf("testa_start is endding.\n");
            return 0;
        }
        printf("testa_start is running\n");
        sleep(1);
    }

    return 0;
}

static int testa_stop(void)
{
    printf("testa_stop is running\n");
    flag_stop = true;
    return 0;
}
